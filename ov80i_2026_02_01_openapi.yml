openapi: 3.0.3
info:
  title: OV80i Edge API
  version: "2026.02.01"

servers:
  - url: http://192.168.1.1

tags:
  - name: Healthcheck
  - name: Recipe
  - name: Camera & Captures
  - name: Device
  - name: Files
  - name: Updates
  - name: Certificates
  - name: Web Server
  - name: Industrial Ethernet
  - name: Node-RED
  - name: Remote Storage
  - name: Environment
  - name: Logs

paths:
  # ── Healthcheck ──────────────────────────────────────────────
  /edge/v2/healthcheck:
    get:
      tags: [Healthcheck]
      summary: Device health status
      operationId: healthcheck
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  healthcheck:
                    type: integer
                    example: 200

  # ── Recipe Management ────────────────────────────────────────
  /edge/recipe:
    get:
      tags: [Recipe]
      summary: List all recipes
      operationId: listRecipes
      responses:
        "200":
          description: Array of recipe objects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/RecipeSummary"
    post:
      tags: [Recipe]
      summary: Create a new recipe
      operationId: createRecipe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecipeCreate"
      responses:
        "201":
          description: Created recipe
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecipeCreate"

  /edge/recipe/{id}:
    parameters:
      - $ref: "#/components/parameters/RecipeId"
    get:
      tags: [Recipe]
      summary: Get recipe by ID
      operationId: getRecipe
      responses:
        "200":
          description: Recipe object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecipeDetail"
    patch:
      tags: [Recipe]
      summary: Update a recipe
      operationId: updateRecipe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RecipeUpdate"
      responses:
        "204":
          description: Updated
        "400":
          description: Missing or invalid body
    delete:
      tags: [Recipe]
      summary: Delete a recipe
      operationId: deleteRecipe
      responses:
        "204":
          description: Deleted

  /edge/recipe/active:
    get:
      tags: [Recipe]
      summary: Get the active recipe
      operationId: getActiveRecipe
      responses:
        "200":
          description: Active recipe
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RecipeDetail"

  /edge/recipe/{id}/imaging-settings:
    parameters:
      - $ref: "#/components/parameters/RecipeId"
    patch:
      tags: [Recipe]
      summary: Update imaging settings for a recipe
      operationId: updateImagingSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ImagingSettings"
      responses:
        "204":
          description: Updated
        "400":
          description: Missing or invalid body

  /edge/recipe/activate:
    post:
      tags: [Recipe]
      summary: Activate recipe by database ID
      operationId: activateRecipeById
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: integer
                  example: 22
      responses:
        "200":
          description: Activated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  details:
                    type: string
        "400":
          description: Invalid or missing payload
        "408":
          description: Recipe switch timed out
        "429":
          description: Another recipe switch is in progress
        "500":
          description: Recipe switch failed

  /edge/api/recipes/{recipe_id}/activate:
    parameters:
      - name: recipe_id
        in: path
        required: true
        description: PLC recipe ID
        schema:
          type: integer
    post:
      tags: [Recipe]
      summary: Activate recipe by PLC recipe ID
      operationId: activateRecipeByPlcId
      responses:
        "200":
          description: Activated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  recipe_id:
                    type: integer
        "404":
          description: Recipe not found
        "429":
          description: Another recipe switch is in progress
        "500":
          description: Error activating recipe
        "504":
          description: Timeout while activating recipe

  /edge/recipe/export:
    post:
      tags: [Recipe]
      summary: Export recipe as ZIP
      operationId: exportRecipe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recipe_id]
              properties:
                recipe_id:
                  type: integer
                  example: 22
                max_images:
                  type: integer
                  example: 5000
                include_library_captures:
                  type: boolean
                  default: false
      responses:
        "200":
          description: Streaming ZIP file
          headers:
            X-Approx-Size-Bytes:
              description: Approximate ZIP size in bytes
              schema:
                type: integer
          content:
            application/zip:
              schema:
                type: string
                format: binary
        "400":
          description: Missing payload
        "500":
          description: Export error

  /edge/recipe/check-upload-space:
    post:
      tags: [Recipe]
      summary: Check disk space for recipe upload
      operationId: checkUploadSpace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [file_size_bytes]
              properties:
                file_size_bytes:
                  type: integer
                  example: 104857600
      responses:
        "200":
          description: Sufficient space
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  details:
                    type: string
                  result:
                    type: object
                    properties:
                      space_available_bytes:
                        type: integer
                      space_required_bytes:
                        type: integer
        "400":
          description: Missing or invalid file_size_bytes
        "507":
          description: Insufficient storage

  /edge/recipe/import:
    post:
      tags: [Recipe]
      summary: Import recipe from ZIP
      operationId: importRecipe
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: Imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  details:
                    type: string
                  result:
                    type: integer
                    description: New recipe database ID
        "400":
          description: No file provided or empty file
        "422":
          description: Empty filename or invalid file content
        "429":
          description: Another import is in progress
        "500":
          description: Import error

  /edge/recipe/change_plc_recipe_id:
    post:
      tags: [Recipe]
      summary: Change PLC recipe ID
      operationId: changePlcRecipeId
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recipe_id, target_plc_recipe_id]
              properties:
                recipe_id:
                  type: integer
                  example: 22
                target_plc_recipe_id:
                  type: integer
                  minimum: 1
                  maximum: 65535
                  example: 200
                restart_pipeline:
                  type: boolean
                  default: true
      responses:
        "200":
          description: Success
          content:
            text/plain:
              schema:
                type: string
                example: Success
        "400":
          description: Missing fields or ID out of range (1–65535)
        "409":
          description: PLC recipe ID already exists

  /edge/recipe/deployment-status:
    get:
      tags: [Recipe]
      summary: Deployment status of active recipe blocks
      operationId: getDeploymentStatus
      responses:
        "200":
          description: Deployment status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeploymentStatus"

  # ── Camera & Captures ───────────────────────────────────────
  /edge/camera/capture:
    post:
      tags: [Camera & Captures]
      summary: Capture a single frame
      operationId: captureCamera
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                subdir:
                  type: string
                  example: library_captures
      responses:
        "200":
          description: Capture object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Capture"

  /edge/captures/upload:
    post:
      tags: [Camera & Captures]
      summary: Upload an image as a new capture
      operationId: uploadCapture
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "200":
          description: Capture with notes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CaptureWithNotes"
        "400":
          description: Missing file
        "415":
          description: Unsupported file type (only jpg, jpeg, png)
        "422":
          description: Empty filename

  /edge/capture_result:
    get:
      tags: [Camera & Captures]
      summary: Get capture results for active recipe
      operationId: getCaptureResults
      responses:
        "200":
          description: Array of capture results (most recent first)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CaptureResult"

  /edge/capture_result/user_metadata/keys:
    get:
      tags: [Camera & Captures]
      summary: List user metadata keys (sorted by frequency)
      operationId: getCaptureResultMetadataKeys
      responses:
        "200":
          description: Array of key strings
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                example: ["batch_id", "operator"]

  /edge/capture_result/{capture_id}/heatmap:
    parameters:
      - name: capture_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Camera & Captures]
      summary: Download heatmap image for a capture
      operationId: getCaptureHeatmap
      responses:
        "200":
          description: PNG image
          content:
            image/png:
              schema:
                type: string
                format: binary
        "404":
          description: Capture not found, heatmap missing, or not in active recipe

  /edge/v2/capture:
    delete:
      tags: [Camera & Captures]
      summary: Delete multiple captures by ID
      operationId: deleteCaptures
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ids]
              properties:
                ids:
                  type: array
                  items:
                    type: integer
                  example: [123, 124, 125]
      responses:
        "200":
          description: Deletion result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkDeleteResult"
        "400":
          description: Missing or invalid body
        "500":
          description: Internal server error

  /edge/v2/capture/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Camera & Captures]
      summary: Get capture by ID
      operationId: getCapture
      responses:
        "200":
          description: Capture object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CaptureDetail"
        "400":
          description: Invalid request
        "404":
          description: Capture not found

  /edge/v2/capture/{capture_id}/notes:
    parameters:
      - name: capture_id
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Camera & Captures]
      summary: Create or update capture notes
      operationId: upsertCaptureNotes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [notes]
              properties:
                notes:
                  type: string
                  example: Example note text
      responses:
        "201":
          description: Note created/updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CaptureNote"
        "400":
          description: Missing or invalid body
    put:
      tags: [Camera & Captures]
      summary: Create or update capture notes
      operationId: upsertCaptureNotesPut
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [notes]
              properties:
                notes:
                  type: string
                  example: Example note text
      responses:
        "201":
          description: Note created/updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CaptureNote"
        "400":
          description: Missing or invalid body

  /edge/v2/capture/library:
    get:
      tags: [Camera & Captures]
      summary: List library captures with filtering and pagination
      operationId: listLibraryCaptures
      parameters:
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [ascending, descending]
        - name: captured_from
          in: query
          schema:
            type: string
            format: date-time
        - name: captured_until
          in: query
          schema:
            type: string
            format: date-time
        - name: recipe
          in: query
          schema:
            type: integer
        - name: id
          in: query
          description: Single ID or comma-separated list
          schema:
            type: string
        - name: inspection_region
          in: query
          description: JSON string
          schema:
            type: string
        - name: search_areas
          in: query
          description: Comma-separated list
          schema:
            type: string
        - name: inspection_type
          in: query
          description: JSON string
          schema:
            type: string
        - name: exclude_trainset
          in: query
          schema:
            type: boolean
        - name: trainset_only
          in: query
          schema:
            type: boolean
        - name: alignment_fails_only
          in: query
          schema:
            type: boolean
        - name: capture_notes
          in: query
          schema:
            type: string
        - name: pass_or_fail
          in: query
          schema:
            type: boolean
        - name: trigger_id
          in: query
          description: Single ID or comma-separated list
          schema:
            type: string
        - name: metadata_keys
          in: query
          description: Comma-separated list
          schema:
            type: string
        - name: metadata
          in: query
          description: JSON string
          schema:
            type: string
        - name: has_capture_result
          in: query
          schema:
            type: boolean
        - name: page_start_index
          in: query
          schema:
            type: integer
        - name: page_size
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: Paginated captures
          content:
            application/json:
              schema:
                type: object
                properties:
                  captures:
                    type: array
                    items:
                      $ref: "#/components/schemas/LibraryCapture"
                  totalCapturesCount:
                    type: integer
        "400":
          description: Invalid request data
        "500":
          description: Error getting library captures

  /edge/v2/capture/library/{capture_id}:
    parameters:
      - name: capture_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Camera & Captures]
      summary: Get a library capture with results
      operationId: getLibraryCapture
      responses:
        "200":
          description: Library capture with all results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LibraryCaptureDetail"
        "400":
          description: Invalid request data
        "500":
          description: Error getting library capture

  /edge/v2/capture/library/filters/recipe/{recipe_id}:
    parameters:
      - name: recipe_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Camera & Captures]
      summary: Get filter options for library captures by recipe
      operationId: getLibraryFilters
      responses:
        "200":
          description: Filter options
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LibraryFilterOptions"
        "400":
          description: recipe_id must be a positive integer
        "404":
          description: Recipe not found
        "500":
          description: Error getting filter options

  /edge/v2/capture/all:
    delete:
      tags: [Camera & Captures]
      summary: Delete all captures (destructive)
      operationId: deleteAllCaptures
      responses:
        "200":
          description: Deletion result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BulkDeleteResult"
        "500":
          description: Internal server error

  /edge/camera/do:
    post:
      tags: [Camera & Captures]
      summary: Set a digital output pin value
      operationId: setDigitalOutput
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pin, value]
              properties:
                pin:
                  type: integer
                  example: 1
                value:
                  type: integer
                  example: 1
      responses:
        "200":
          description: OK
        "400":
          description: Missing pin/value or hardware error

  /edge/camera/led_color:
    get:
      tags: [Camera & Captures]
      summary: Get current LED color
      operationId: getLedColor
      responses:
        "200":
          description: LED color value (0=off, 1=green, 2=orange, 3=yellow)
          content:
            text/plain:
              schema:
                type: integer
                enum: [0, 1, 2, 3]
    post:
      tags: [Camera & Captures]
      summary: Set LED color
      operationId: setLedColor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [value]
              properties:
                value:
                  type: integer
                  enum: [0, 1, 2, 3]
                  description: "0=off, 1=green, 2=orange, 3=yellow"
      responses:
        "200":
          description: OK
        "400":
          description: Missing or invalid payload

  # ── Device & System ─────────────────────────────────────────
  /edge/device/name:
    get:
      tags: [Device]
      summary: Get device name
      operationId: getDeviceName
      responses:
        "200":
          description: Device name
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: c111
    post:
      tags: [Device]
      summary: Set device name
      operationId: setDeviceName
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: c111
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "400":
          description: Missing or invalid payload

  /edge/v2/device/network:
    get:
      tags: [Device]
      summary: Get network configuration
      operationId: getNetwork
      responses:
        "200":
          description: Network configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NetworkConfig"
    post:
      tags: [Device]
      summary: Update network configuration
      operationId: setNetwork
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NetworkSettings"
      responses:
        "200":
          description: OK
        "400":
          description: Invalid payload

  /edge/v2/device/storage:
    get:
      tags: [Device]
      summary: Get storage usage
      operationId: getStorage
      responses:
        "200":
          description: Storage info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StorageInfo"

  /edge/v2/device/serial_number:
    get:
      tags: [Device]
      summary: Get device serial number
      operationId: getSerialNumber
      responses:
        "200":
          description: Serial number
          content:
            application/json:
              schema:
                type: object
                properties:
                  serial_number:
                    type: string
                    example: gsac059110

  /edge/v2/device/activation:
    get:
      tags: [Device]
      summary: Get activation status
      operationId: getActivation
      responses:
        "200":
          description: Activation status
          content:
            application/json:
              schema:
                type: object
                properties:
                  activated:
                    type: boolean

  /edge/v2/device/hostname:
    get:
      tags: [Device]
      summary: Get hostname
      operationId: getHostname
      responses:
        "200":
          description: Hostname
          content:
            application/json:
              schema:
                type: object
                properties:
                  hostname:
                    type: string
                    example: ov80i-gsac059110
    post:
      tags: [Device]
      summary: Set hostname
      operationId: setHostname
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [hostname]
              properties:
                hostname:
                  type: string
                  example: ov80i-gsac059110
      responses:
        "200":
          description: Hostname set
          content:
            application/json:
              schema:
                type: object
                properties:
                  hostname:
                    type: string
        "400":
          description: Missing or invalid hostname
        "500":
          description: Failed to set hostname

  /edge/v2/device/camera_type:
    get:
      tags: [Device]
      summary: Get camera model type
      operationId: getCameraType
      responses:
        "200":
          description: Camera type
          content:
            application/json:
              schema:
                type: object
                properties:
                  camera_type:
                    type: string
                    example: ov80i

  /edge/v2/device/time:
    get:
      tags: [Device]
      summary: Get system time in microseconds
      operationId: getTime
      responses:
        "200":
          description: System time
          content:
            application/json:
              schema:
                type: object
                properties:
                  now_us:
                    type: integer
                    format: int64
                    example: 1770728704381184
    post:
      tags: [Device]
      summary: Set system time in microseconds
      operationId: setTime
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [now_us]
              properties:
                now_us:
                  type: integer
                  format: int64
                  example: 1770728704381184
      responses:
        "200":
          description: OK
        "400":
          description: Missing payload

  /edge/v2/device/ntp:
    get:
      tags: [Device]
      summary: Get NTP configuration
      operationId: getNtp
      responses:
        "200":
          description: NTP config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NtpConfig"
    post:
      tags: [Device]
      summary: Update NTP configuration
      operationId: setNtp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NtpConfig"
      responses:
        "200":
          description: Successfully set NTP configuration
          content:
            text/plain:
              schema:
                type: string
        "400":
          description: Missing payload

  /edge/v2/device/restart:
    post:
      tags: [Device]
      summary: Restart device
      operationId: restartDevice
      responses:
        "200":
          description: Restarting
          content:
            application/json:
              schema:
                type: object

  /edge/v2/device/version:
    get:
      tags: [Device]
      summary: Get software version
      operationId: getVersion
      responses:
        "200":
          description: Version
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    example: ov80i_2025.12

  # ── Environment Variables ────────────────────────────────────
  /edge/environmental_variables:
    get:
      tags: [Environment]
      summary: Get Node-RED environment variables
      operationId: getEnvVars
      responses:
        "200":
          description: Environment variables as plain text
          content:
            text/plain:
              schema:
                type: string
                example: |
                  LINE_CODE=line1
                  CAMERA_TIMEZONE=GMT-3
                  DATE_INSTALLED=2026-01-01
        "500":
          description: Failed to read environment variables
    post:
      tags: [Environment]
      summary: Overwrite Node-RED environment variables
      operationId: setEnvVars
      requestBody:
        required: true
        content:
          text/plain:
            schema:
              type: string
              example: |
                LINE_CODE=line2
                CAMERA_TIMEZONE=GMT-5
                DATE_INSTALLED=2026-01-01
      responses:
        "200":
          description: Environment file updated successfully
          content:
            text/plain:
              schema:
                type: string
        "400":
          description: Empty body
        "500":
          description: Failed to write environment variables

  # ── Logs ─────────────────────────────────────────────────────
  /edge/create_manual_log_entry:
    post:
      tags: [Logs]
      summary: Create a manual log entry
      operationId: createManualLogEntry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [msg]
              properties:
                msg:
                  type: string
                  example: Manual log entry from API
      responses:
        "200":
          description: Success
          content:
            text/plain:
              schema:
                type: string
                example: Success
        "400":
          description: Missing or invalid JSON payload
        "500":
          description: Failed to create log entry

  # ── Files ────────────────────────────────────────────────────
  /edge/v2/files/{file_path}:
    parameters:
      - name: file_path
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [Files]
      summary: Download a file from the data directory
      operationId: downloadFile
      parameters:
        - name: cache_max_age
          in: query
          schema:
            type: integer
          description: Cache duration in seconds
        - name: width
          in: query
          schema:
            type: integer
          description: Resize width for JPEG images
      responses:
        "200":
          description: File bytes
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "404":
          description: File not found

  # ── Updates ──────────────────────────────────────────────────
  /edge/update:
    get:
      tags: [Updates]
      summary: List update files
      operationId: listUpdates
      responses:
        "200":
          description: Array of update files
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UpdateFile"

  /edge/update/status:
    get:
      tags: [Updates]
      summary: Get update status
      operationId: getUpdateStatus
      responses:
        "200":
          description: Update status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: finished
                  logs:
                    type: string
                    description: Included when status is "error"

  # ── Certificates ─────────────────────────────────────────────
  /edge/certificates:
    get:
      tags: [Certificates]
      summary: List HTTPS certificates
      operationId: listCertificates
      responses:
        "200":
          description: Array of certificates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Certificate"
        "500":
          description: Failed to list certificates

  /edge/certificates/{certificate_id}:
    parameters:
      - name: certificate_id
        in: path
        required: true
        schema:
          type: integer
    delete:
      tags: [Certificates]
      summary: Delete a certificate
      operationId: deleteCertificate
      responses:
        "204":
          description: Deleted
        "400":
          description: Active certificate cannot be deleted while HTTPS is enabled
        "404":
          description: Certificate not found
        "500":
          description: Failed to delete certificate

  /edge/certificates/{certificate_id}/set_active:
    parameters:
      - name: certificate_id
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Certificates]
      summary: Set certificate as active
      operationId: setActiveCertificate
      responses:
        "200":
          description: Certificate activated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  certificate_id:
                    type: integer
        "404":
          description: Certificate not found
        "500":
          description: Failed to set certificate as active

  # ── Web Server ───────────────────────────────────────────────
  /edge/web_server/protocols:
    get:
      tags: [Web Server]
      summary: Get HTTP/HTTPS enablement
      operationId: getProtocols
      responses:
        "200":
          description: Protocol status
          content:
            application/json:
              schema:
                type: object
                properties:
                  http:
                    type: boolean
                  https:
                    type: boolean
    post:
      tags: [Web Server]
      summary: Update HTTP/HTTPS enablement
      operationId: setProtocols
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                http:
                  type: boolean
                https:
                  type: boolean
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "400":
          description: Missing/invalid fields or both disabled
        "500":
          description: Failed to update protocol

  # ── Industrial Ethernet ──────────────────────────────────────
  /edge/industrial_ethernet/protocol:
    get:
      tags: [Industrial Ethernet]
      summary: Get active industrial ethernet protocol
      operationId: getIndustrialProtocol
      responses:
        "200":
          description: Active protocol
          content:
            application/json:
              schema:
                type: object
                properties:
                  active_protocol:
                    type: string
                    example: profinet
        "500":
          description: Failed to get protocol
    post:
      tags: [Industrial Ethernet]
      summary: Set active industrial ethernet protocol
      operationId: setIndustrialProtocol
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [active_protocol]
              properties:
                active_protocol:
                  type: string
                  example: profinet
      responses:
        "200":
          description: Success
          content:
            text/plain:
              schema:
                type: string
                example: Success
        "400":
          description: Missing or invalid payload
        "500":
          description: Failed to set protocol

  /edge/download/industrial_ethernet/ethernet_ip_eds:
    get:
      tags: [Industrial Ethernet]
      summary: Download Ethernet/IP EDS ZIP
      operationId: downloadEdsZip
      responses:
        "200":
          description: ZIP file
          content:
            application/zip:
              schema:
                type: string
                format: binary
        "404":
          description: EDS file not found
        "500":
          description: Download failed

  /edge/download/industrial_ethernet/profinet_gsdml:
    get:
      tags: [Industrial Ethernet]
      summary: Download Profinet GSDML ZIP
      operationId: downloadGsdmlZip
      responses:
        "200":
          description: ZIP file
          content:
            application/zip:
              schema:
                type: string
                format: binary
        "404":
          description: GSDML file not found
        "500":
          description: Download failed

  /edge/industrial_ethernet/profinet/device_name:
    get:
      tags: [Industrial Ethernet]
      summary: Get Profinet device name
      operationId: getProfinetDeviceName
      responses:
        "200":
          description: Profinet device name
          content:
            application/json:
              schema:
                type: object
                properties:
                  profinet_device_name:
                    type: string
                    example: OV80i
        "500":
          description: Failed to get Profinet device name
    post:
      tags: [Industrial Ethernet]
      summary: Set Profinet device name
      operationId: setProfinetDeviceName
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [profinet_device_name]
              properties:
                profinet_device_name:
                  type: string
                  example: OV80i
      responses:
        "200":
          description: Success
          content:
            text/plain:
              schema:
                type: string
                example: Success
        "400":
          description: Profinet not active or invalid payload
        "500":
          description: Failed to set Profinet device name

  # ── Node-RED ─────────────────────────────────────────────────
  /edge/nodered/flow:
    get:
      tags: [Node-RED]
      summary: Get Node-RED flow for active recipe
      operationId: getNodeRedFlow
      responses:
        "200":
          description: Flow data
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodered_flow:
                    $ref: "#/components/schemas/NodeRedFlow"
        "404":
          description: Flow not found
    post:
      tags: [Node-RED]
      summary: Create or update Node-RED flow
      operationId: upsertNodeRedFlow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [nodered_flow]
              properties:
                nodered_flow:
                  $ref: "#/components/schemas/NodeRedFlow"
                classification_data:
                  nullable: true
                segmentation_data:
                  nullable: true
                ocr_data:
                  nullable: true
                refresh_nodered:
                  type: boolean
                  default: false
      responses:
        "200":
          description: Flow created/updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        "400":
          description: Invalid payload
        "500":
          description: Failed to create/update flow

  /edge/nodered/flow/toggle-basic-mode:
    post:
      tags: [Node-RED]
      summary: Toggle basic mode for active recipe flow
      operationId: toggleBasicMode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [disabled]
              properties:
                disabled:
                  type: boolean
      responses:
        "200":
          description: Toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  noderedFlow:
                    type: object
                    properties:
                      basicMode:
                        type: boolean
                      flow:
                        type: array
                        items: {}
        "400":
          description: Invalid payload
        "500":
          description: Failed to convert flow

  # ── Remote Storage ───────────────────────────────────────────
  /edge/remote_storage/upload_test:
    post:
      tags: [Remote Storage]
      summary: Queue a remote storage upload test
      operationId: remoteStorageUploadTest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RemoteStorageSettings"
      responses:
        "200":
          description: Test queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        "400":
          description: Request body is required
        "500":
          description: Upload test failed

  /edge/remote_storage/settings:
    post:
      tags: [Remote Storage]
      summary: Upsert remote storage settings for active recipe
      operationId: upsertRemoteStorageSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RemoteStorageSettings"
      responses:
        "200":
          description: Settings upserted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  id:
                    type: integer
                  recipe_id:
                    type: integer
        "400":
          description: Missing body or validation error
        "500":
          description: Failed to upsert settings

  # ── Segmentation Results (from existing spec) ────────────────
  /edge/v2/block/segmentation/results:
    get:
      tags: [Camera & Captures]
      summary: Get block segmentation results by capture ID
      description: |
        Returns segmentation, mask, statistics, and region extraction
        results for all blocks under a given capture.
      operationId: getSegmentationResults
      parameters:
        - name: capture_id
          in: query
          required: true
          description: Capture ID
          schema:
            type: integer
            example: 89057
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SegmentationResult"

# ═══════════════════════════════════════════════════════════════
components:
  parameters:
    RecipeId:
      name: id
      in: path
      required: true
      schema:
        type: integer

  schemas:
    # ── Recipe ───────────────────────────────────────────────
    RecipeCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          example: New Recipe
        description:
          type: string
        plc_recipe_id:
          type: integer
          example: 100
        active:
          type: boolean
        hmi_type:
          type: string
          example: default
        edited_at:
          type: string
          format: date-time

    RecipeUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        plc_recipe_id:
          type: integer
        active:
          type: boolean
        hmi_type:
          type: string

    RecipeSummary:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        active:
          type: boolean
          nullable: true
        hmiType:
          type: string
        plcRecipeId:
          type: integer
        createdAt:
          type: string
          format: date-time
        editedAt:
          type: string
          format: date-time
        blockInstances:
          type: array
          items:
            $ref: "#/components/schemas/BlockInstanceBrief"
        imagingSettings:
          $ref: "#/components/schemas/ImagingSettings"

    RecipeDetail:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        active:
          type: boolean
          nullable: true
        hmiType:
          type: string
        plcRecipeId:
          type: integer
        createdAt:
          type: string
          format: date-time
        editedAt:
          type: string
          format: date-time
        remoteStorageSettings:
          nullable: true
        blockInstances:
          type: array
          items:
            $ref: "#/components/schemas/BlockInstance"
        imagingSettings:
          $ref: "#/components/schemas/ImagingSettings"

    BlockInstanceBrief:
      type: object
      properties:
        id:
          type: integer
        blockType:
          type: string
          enum: [alignment, classification, segmentation]

    BlockInstance:
      type: object
      properties:
        id:
          type: integer
        uuid:
          type: string
          format: uuid
        blockType:
          type: string
          enum: [alignment, classification, segmentation]
        name:
          type: string
        recipeId:
          type: integer
        mask:
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    ImagingSettings:
      type: object
      properties:
        id:
          type: integer
        acqMode:
          type: integer
        alignerTriggerDebounceMs:
          type: integer
        awbBlue:
          type: integer
        awbGreen:
          type: integer
        awbOp:
          type: boolean
        awbRed:
          type: integer
        baslerLightSourcePreset:
          type: string
          example: Daylight5000K
        brightness:
          type: integer
        estimatedCaptureTime:
          type: integer
        exposure:
          type: integer
        focalLength:
          type: number
          format: float
        focus:
          type: integer
        focusDistance:
          type: integer
        gain:
          type: integer
        gamma:
          type: integer
        hdrModeEnabled:
          type: boolean
        intervalTriggerPeriod:
          type: integer
        ledGain:
          type: integer
        ledMode:
          type: integer
        ledStrobeMode:
          type: boolean
        lensCorrect:
          type: boolean
        photometricEnabled:
          type: boolean
        photometricMode:
          type: integer
        previewImagePath:
          type: string
          nullable: true
        rotationMode:
          type: integer
        smartRoi:
          nullable: true
        status:
          type: string
          enum: [new, ready]
        triggerDebounce:
          type: integer
        triggerDelay:
          type: integer

    DeploymentStatus:
      type: object
      properties:
        alignerDeployed:
          type: boolean
        anyClassifierDeployed:
          type: boolean
        anySegmenterDeployed:
          type: boolean
        classifierDeployed:
          type: boolean
        hasClassificationBlocks:
          type: boolean
        hasSegmentationBlocks:
          type: boolean
        overallDeployed:
          type: boolean
        segmenterDeployed:
          type: boolean

    # ── Capture ──────────────────────────────────────────────
    Capture:
      type: object
      properties:
        id:
          type: integer
        path:
          type: string
        height:
          type: integer
        width:
          type: integer
        size:
          type: integer
        triggered_by:
          type: string
        source_recipe_id:
          type: integer
        captured_at:
          type: string
          format: date-time

    CaptureWithNotes:
      allOf:
        - $ref: "#/components/schemas/Capture"
        - type: object
          properties:
            capture_notes:
              $ref: "#/components/schemas/CaptureNote"

    CaptureDetail:
      type: object
      properties:
        id:
          type: integer
        uuid:
          type: string
          format: uuid
        path:
          type: string
        height:
          type: integer
        width:
          type: integer
        size:
          type: integer
        triggeredBy:
          type: string
        sourceRecipeId:
          type: integer
        capturedAt:
          type: string
          format: date-time
        ledMode:
          type: integer
          nullable: true
        triggerId:
          type: integer
          nullable: true
        processEnd:
          type: string
          nullable: true
        acqModeAtCapture:
          type: integer
        cameraSettings:
          $ref: "#/components/schemas/CameraSettings"
        captureNotes:
          allOf:
            - $ref: "#/components/schemas/CaptureNote"
          nullable: true

    CaptureNote:
      type: object
      properties:
        id:
          type: integer
        captureId:
          type: integer
        notes:
          type: string
        createdAt:
          type: string
          format: date-time

    CaptureResult:
      type: object
      properties:
        id:
          type: integer
        capture:
          type: integer
        created_at:
          type: string
          format: date-time
        user_metadata:
          type: object
          additionalProperties: true

    BulkDeleteResult:
      type: object
      properties:
        successful:
          type: integer
        failed:
          type: integer

    LibraryCapture:
      type: object
      properties:
        id:
          type: integer
        uuid:
          type: string
          format: uuid
        capturedAt:
          type: string
          format: date-time
        height:
          type: integer
        width:
          type: integer
        path:
          type: string
        size:
          type: integer
        triggeredBy:
          type: string
        sourceRecipeId:
          type: integer
        ledMode:
          type: integer
          nullable: true
        triggerId:
          type: integer
          nullable: true
        processEnd:
          type: string
          nullable: true
        acqModeAtCapture:
          type: integer
        recipe:
          $ref: "#/components/schemas/LibraryRecipe"
        captureResult:
          nullable: true
        isForTraining:
          type: boolean
          nullable: true

    LibraryCaptureDetail:
      allOf:
        - $ref: "#/components/schemas/LibraryCapture"
        - type: object
          properties:
            cameraSettings:
              allOf:
                - $ref: "#/components/schemas/CameraSettings"
              nullable: true
            captureNotes:
              allOf:
                - $ref: "#/components/schemas/CaptureNote"
              nullable: true
            alignmentResults:
              type: array
              items: {}
            classificationResults:
              type: array
              items: {}
            segmentationResults:
              type: array
              items: {}
            ocrResults:
              type: array
              items: {}

    LibraryRecipe:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        blockInstances:
          type: array
          items:
            $ref: "#/components/schemas/LibraryBlockInstance"

    LibraryBlockInstance:
      type: object
      properties:
        id:
          type: integer
        uuid:
          type: string
          format: uuid
        blockType:
          type: string
          enum: [alignment, classification, segmentation]
        classificationHyperparameters:
          nullable: true
        segmentationHyperparameters:
          nullable: true

    LibraryFilterOptions:
      type: object
      properties:
        id:
          type: integer
        searchAreas:
          type: array
          items:
            $ref: "#/components/schemas/SearchArea"
        inspectionRegions:
          type: array
          items:
            $ref: "#/components/schemas/InspectionRegion"
        inspectionTypes:
          type: array
          items:
            $ref: "#/components/schemas/InspectionTypeWithClasses"

    # ── Device ───────────────────────────────────────────────
    NetworkConfig:
      type: object
      properties:
        active:
          $ref: "#/components/schemas/NetworkSettings"
        configuration:
          $ref: "#/components/schemas/NetworkSettings"
        mac_address:
          type: string
          example: "3C:6D:66:01:82:0C"

    NetworkSettings:
      type: object
      properties:
        address:
          type: string
          example: 192.168.15.111
        dns:
          type: array
          items:
            type: string
        gateway:
          type: string
          example: 192.168.15.1
        mode:
          type: string
          enum: [static, dhcp]
        netmask:
          type: string
          example: 255.255.255.0

    StorageInfo:
      type: object
      properties:
        total:
          type: integer
          format: int64
        used:
          type: integer
          format: int64
        free:
          type: integer
          format: int64
        percent:
          type: number
          format: float
        endurance:
          nullable: true

    NtpConfig:
      type: object
      properties:
        enabled:
          type: boolean
        servers:
          type: array
          items:
            type: string

    # ── System ───────────────────────────────────────────────
    UpdateFile:
      type: object
      properties:
        filename:
          type: string
        last_modified:
          type: number
          format: double
        name:
          type: string
        size:
          type: integer
          format: int64
        valid:
          type: boolean

    Certificate:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        createdAt:
          type: string
          format: date-time
        commonName:
          type: string
        ipAddress:
          type: string
        issuerName:
          type: string
        issuerOrganization:
          type: string
        organization:
          type: string
        organizationalUnit:
          type: string
        country:
          type: string
        validFrom:
          type: string
          format: date-time
        validTo:
          type: string
          format: date-time
        isActive:
          type: boolean

    RemoteStorageSettings:
      type: object
      properties:
        protocol:
          type: string
          example: sftp
        host:
          type: string
          example: 127.0.0.1
        port:
          type: integer
          example: 22
        username:
          type: string
        password:
          type: string
        remote_dir:
          type: string
          example: /
        enabled:
          type: boolean
        add_trigger_id:
          type: boolean

    NodeRedFlow:
      type: object
      properties:
        flow:
          type: array
          items: {}
        basic_mode:
          type: boolean
        basic_flow_id:
          type: string
        basic_flow_metadata:
          type: object
          additionalProperties: true

    # ── Shared / Reused from existing spec ───────────────────
    CameraSettings:
      type: object
      properties:
        acq_mode:
          type: integer
        aligner_trigger_debounce_ms:
          type: integer
        awb_blue:
          type: integer
        awb_green:
          type: integer
        awb_red:
          type: integer
        awb_op:
          type: boolean
        basler_light_source_preset:
          type: string
          example: Daylight5000K
        brightness:
          type: integer
        estimated_capture_time:
          type: integer
        exposure:
          type: integer
        focal_length:
          type: number
          format: float
        focus:
          type: integer
        focus_distance:
          type: integer
        gain:
          type: integer
        gamma:
          type: integer
        hdr_mode_enabled:
          type: boolean
        interval_trigger_period:
          type: integer
        led_gain:
          type: integer
        led_mode:
          type: integer
        led_strobe_mode:
          type: boolean
        lens_correct:
          type: boolean
        photometric_enabled:
          type: boolean
        photometric_mode:
          type: integer
        preview_image_path:
          type: string
          nullable: true
        recipe_id:
          type: integer
        rotation_mode:
          type: integer
        smart_roi:
          nullable: true
        status:
          type: string
        trigger_debounce:
          type: integer
        trigger_delay:
          type: integer

    SegmentationResult:
      type: object
      required: [id, blockId, captureId, imageScore]
      properties:
        id:
          type: integer
        blockId:
          type: integer
        captureId:
          type: integer
        confidenceScoreThreshold:
          type: number
          format: float
        imageScore:
          type: number
          format: float
        block:
          $ref: "#/components/schemas/Block"
        mask:
          type: string
          description: Base64 encoded PNG image
        maskStats:
          $ref: "#/components/schemas/MaskStats"
        regionExtractionResult:
          $ref: "#/components/schemas/RegionExtractionResult"
        regionExtractionResultId:
          type: integer
        searchArea:
          $ref: "#/components/schemas/SearchArea"
        searchAreaId:
          type: integer

    Block:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string

    MaskStats:
      type: object
      properties:
        blobStatistics:
          type: array
          items:
            $ref: "#/components/schemas/BlobStatistic"
        classStatistics:
          type: array
          items:
            $ref: "#/components/schemas/ClassStatistic"

    BlobStatistic:
      type: object
      properties:
        angle:
          type: number
          format: float
        averageColor:
          type: array
          items:
            type: number
          minItems: 3
          maxItems: 3
        center:
          type: array
          items:
            type: number
          minItems: 2
          maxItems: 2
        centerGlobal:
          type: array
          items:
            type: number
          minItems: 2
          maxItems: 2
        centroid:
          type: array
          items:
            type: number
          minItems: 2
          maxItems: 2
        classId:
          type: integer
        className:
          type: string
        majorAxisLength:
          type: number
          format: float
        minorAxisLength:
          type: number
          format: float
        perimeter:
          type: number
          format: float
        pixelCount:
          type: integer

    ClassStatistic:
      type: object
      properties:
        classId:
          type: integer
        className:
          type: string
        numBlobs:
          type: integer
        pixelCount:
          type: integer

    RegionExtractionResult:
      type: object
      properties:
        id:
          type: integer
        alignmentResultId:
          type: integer
        alignmentResult:
          $ref: "#/components/schemas/AlignmentResult"
        inspectionRegionId:
          type: integer
        inspectionRegion:
          $ref: "#/components/schemas/InspectionRegion"
        fabricjsObject:
          $ref: "#/components/schemas/FabricJsObject"
        searchAreaId:
          type: integer

    AlignmentResult:
      type: object
      properties:
        id:
          type: integer
        blockId:
          type: integer
        captureId:
          type: integer
        angle:
          type: number
          format: float
        confidence:
          type: number
          format: float
        centerLoc:
          type: array
          items:
            type: number
          minItems: 2
          maxItems: 2
        affineMatrix:
          type: array
          items:
            type: array
            items:
              type: number
        searchAreaId:
          type: integer
        searchAreaBbox:
          type: array
          items:
            type: number

    InspectionRegion:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        angle:
          type: number
          format: float
        locked:
          type: boolean
        bbox:
          type: array
          items:
            type: number
        inspectionTypeId:
          type: integer
        inspectionType:
          $ref: "#/components/schemas/InspectionType"
        fabricjsObject:
          $ref: "#/components/schemas/FabricJsObject"

    InspectionType:
      type: object
      properties:
        id:
          type: integer
        blockId:
          type: integer
        name:
          type: string

    InspectionTypeWithClasses:
      allOf:
        - $ref: "#/components/schemas/InspectionType"
        - type: object
          properties:
            blockClassificationClasses:
              type: array
              items:
                $ref: "#/components/schemas/ClassificationClass"
            blockSegmentationClasses:
              type: array
              items:
                $ref: "#/components/schemas/SegmentationClass"

    ClassificationClass:
      type: object
      properties:
        id:
          type: integer
        createdAt:
          type: string
          format: date-time
        color:
          type: string
          example: "#00DD00"
        labelName:
          type: string
          example: Pass
        inspectionTypeId:
          type: integer
        inspectionType:
          $ref: "#/components/schemas/InspectionType"

    SegmentationClass:
      type: object
      properties:
        id:
          type: integer
        color:
          type: string
          example: "#EE0000"
        labelName:
          type: string
          example: Fail
        inspectionTypeId:
          type: integer
        maskPixelValue:
          type: integer
        inspectionType:
          $ref: "#/components/schemas/InspectionType"

    SearchArea:
      type: object
      properties:
        id:
          type: integer
        blockId:
          type: integer
        alignmentParamsId:
          type: integer
        main:
          type: boolean
        name:
          type: string
        searchAreaBbox:
          type: array
          items:
            type: number

    FabricJsObject:
      type: object
      description: Fabric.js serialized object
      additionalProperties: true
